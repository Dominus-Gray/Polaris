name: Contract Diff Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'contracts/**'
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'contracts/**'
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      override_breaking_changes:
        description: 'Override breaking changes (use with caution)'
        required: false
        default: 'false'
        type: boolean

jobs:
  contract-diff:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install fastapi uvicorn pydantic python-jose[cryptography] python-multipart
        if [ -f backend/requirements.txt ]; then
          # Install only available packages, skip proprietary ones
          grep -v 'emergentintegrations\|litellm' backend/requirements.txt > requirements_filtered.txt || true
          pip install -r requirements_filtered.txt || true
        fi
    
    - name: Extract current OpenAPI specifications
      run: |
        cd scripts
        python extract_openapi_spec.py ../contracts/openapi
      continue-on-error: true  # Don't fail if extraction has issues
    
    - name: Run contract diff analysis (PR)
      if: github.event_name == 'pull_request'
      run: |
        cd scripts
        
        # Get base branch contracts for comparison
        git checkout ${{ github.base_ref }}
        python extract_openapi_spec.py /tmp/base_contracts || true
        
        # Switch back to PR branch
        git checkout ${{ github.head_ref }}
        python extract_openapi_spec.py /tmp/current_contracts || true
        
        # Run diff analysis
        echo "## Contract Diff Analysis" > contract_diff_report.md
        echo "" >> contract_diff_report.md
        
        if [ -f /tmp/base_contracts/public-v1.json ] && [ -f /tmp/current_contracts/public-v1.json ]; then
          echo "Comparing OpenAPI specifications..." >> contract_diff_report.md
          python contract_diff_pipeline.py diff >> contract_diff_report.md 2>&1 || true
        else
          echo "Could not find contract files for comparison" >> contract_diff_report.md
        fi
        
        # Display results
        cat contract_diff_report.md
        
        # Save as artifact
        echo "DIFF_REPORT<<EOF" >> $GITHUB_ENV
        cat contract_diff_report.md >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
    
    - name: Run contract diff analysis (main branch/nightly)
      if: github.event_name == 'push' || github.event_name == 'schedule'
      run: |
        cd scripts
        
        # Extract current contracts
        python extract_openapi_spec.py ../contracts/openapi || true
        
        # Validate current contracts
        python contract_diff_pipeline.py validate
    
    - name: Validate contract policy
      if: github.event_name == 'pull_request'
      run: |
        cd scripts
        
        # Set override token if provided
        if [ "${{ github.event.inputs.override_breaking_changes }}" == "true" ]; then
          export CONTRACT_OVERRIDE_TOKEN="GITHUB_WORKFLOW_OVERRIDE"
        fi
        
        # Run policy validation
        python contract_diff_pipeline.py validate
      env:
        CONTRACT_OVERRIDE_TOKEN: ${{ github.event.inputs.override_breaking_changes == 'true' && 'GITHUB_WORKFLOW_OVERRIDE' || '' }}
    
    - name: Run contract diff tests
      run: |
        cd tests
        python test_contract_diff_pipeline.py
    
    - name: Comment PR with diff results
      if: github.event_name == 'pull_request' && env.DIFF_REPORT != ''
      uses: actions/github-script@v7
      with:
        script: |
          const diffReport = process.env.DIFF_REPORT;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üîç **Contract Diff Analysis Results**\n\n${diffReport}\n\n---\n*This comment was automatically generated by the Contract Diff Pipeline*`
          });
    
    - name: Upload contract artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: contract-specs-${{ github.sha }}
        path: |
          contracts/
          scripts/contract_diff_report.md
        retention-days: 30
    
    - name: Fail on policy violations
      if: failure() && github.event_name == 'pull_request'
      run: |
        echo "‚ùå Contract diff pipeline failed. Check the logs above for details."
        echo "If breaking changes are intentional, you can override with workflow dispatch."
        exit 1